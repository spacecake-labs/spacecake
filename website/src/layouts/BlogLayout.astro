---
/**
 * Layout for blog/article pages
 * Based on CompareLayout with BlogPosting schema, tags, reading time, and optional cover image
 */
import CallToAction from "../components/CallToAction.astro"
import Footer from "../components/Footer.astro"
import Nav from "../components/Nav.astro"

interface Props {
  title: string
  description: string
  tags: string[]
  publishedAt: Date
  updatedAt?: Date
  author?: string
  coverImage?: { src: string; alt: string }
  readingTime: number
  faq?: Array<{ question: string; answer: string }>
  canonical?: string
  noindex?: boolean
}

const {
  title,
  description,
  tags,
  publishedAt,
  updatedAt,
  author = "spacecake team",
  coverImage,
  readingTime,
  faq,
  canonical,
  noindex = false,
} = Astro.props

const currentUrl = Astro.url.href
const canonicalUrl = canonical || currentUrl

const formatDate = (date: Date) =>
  date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  })

// Schema.org BlogPosting markup
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  author: {
    "@type": "Organization",
    name: author,
  },
  publisher: {
    "@type": "Organization",
    name: "spacecake",
    url: "https://spacecake.dev",
  },
  datePublished: publishedAt.toISOString(),
  dateModified: (updatedAt || publishedAt).toISOString(),
  mainEntityOfPage: canonicalUrl,
  ...(coverImage && { image: coverImage.src }),
  keywords: tags.join(", "),
}

// FAQ Schema for rich snippets
const faqSchema = faq?.length
  ? {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      mainEntity: faq.map((item) => ({
        "@type": "Question",
        name: item.question,
        acceptedAnswer: {
          "@type": "Answer",
          text: item.answer,
        },
      })),
    }
  : null
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>{title} | spacecake</title>
    <meta name="title" content={`${title} | spacecake`} />
    <meta name="description" content={description} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Canonical -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph -->
    <meta property="og:type" content="article" />
    <meta property="og:url" content={currentUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:site_name" content="spacecake" />
    {coverImage && <meta property="og:image" content={coverImage.src} />}
    {coverImage && <meta property="og:image:alt" content={coverImage.alt} />}
    <meta
      property="article:published_time"
      content={publishedAt.toISOString()}
    />
    {
      updatedAt && (
        <meta
          property="article:modified_time"
          content={updatedAt.toISOString()}
        />
      )
    }
    {tags.map((tag) => <meta property="article:tag" content={tag} />)}

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {coverImage && <meta name="twitter:image" content={coverImage.src} />}

    <!-- Structured Data -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify(articleSchema)}
    />
    {
      faqSchema && (
        <script
          type="application/ld+json"
          set:html={JSON.stringify(faqSchema)}
        />
      )
    }

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Analytics -->
    <script
      src="https://analytics.ahrefs.com/analytics.js"
      data-key="TJwISHtBcWir5M/lRBkKWw"
      async></script>
  </head>

  <body>
    <Nav active="blog" />

    <main class="main">
      <article class="article">
        <!-- Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="Breadcrumb">
          <a href="/">Home</a>
          <span class="separator">/</span>
          <a href="/blog">Blog</a>
          <span class="separator">/</span>
          <span class="current">{title}</span>
        </nav>

        <!-- Cover Image -->
        {
          coverImage && (
            <div class="cover-image">
              <img src={coverImage.src} alt={coverImage.alt} />
            </div>
          )
        }

        <!-- Header -->
        <header class="header">
          <h1>{title}</h1>

          <!-- Tags -->
          <div class="tags">
            {tags.map((tag) => <span class="tag">{tag}</span>)}
          </div>

          <!-- Meta info -->
          <div class="meta">
            <span class="author">By {author}</span>
            <span class="separator">|</span>
            <time datetime={publishedAt.toISOString()}>
              {formatDate(publishedAt)}
            </time>
            {
              updatedAt && (
                <>
                  <span class="separator">|</span>
                  <span class="updated">
                    Updated:{" "}
                    <time datetime={updatedAt.toISOString()}>
                      {formatDate(updatedAt)}
                    </time>
                  </span>
                </>
              )
            }
            <span class="separator">|</span>
            <span class="reading-time">{readingTime} min read</span>
          </div>
        </header>

        <!-- Main Content -->
        <div class="content">
          <slot />
        </div>

        <!-- FAQ Section -->
        {
          faq && faq.length > 0 && (
            <section class="faq-section">
              <h2>Frequently Asked Questions</h2>
              <div class="faq-list">
                {faq.map((item) => (
                  <details class="faq-item">
                    <summary>{item.question}</summary>
                    <p>{item.answer}</p>
                  </details>
                ))}
              </div>
            </section>
          )
        }

        <!-- CTA Section -->
        <CallToAction />
      </article>
    </main>

    <Footer />
  </body>
</html>

<style>
  :root {
    --font-sans:
      "Geist", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    --color-bg: #0a0a0a;
    --color-bg-elevated: #141414;
    --color-bg-muted: #1a1a1a;
    --color-text: #fafafa;
    --color-text-muted: #a1a1a1;
    --color-border: #262626;
    --color-accent: #10b981;
    --color-accent-muted: rgba(16, 185, 129, 0.1);
    --max-width: 48rem;
    --nav-height: 4.5rem;
  }

  :root[data-theme="light"] {
    --color-bg: #ffffff;
    --color-bg-elevated: #f5f5f5;
    --color-bg-muted: #f0f0f0;
    --color-text: #0a0a0a;
    --color-text-muted: #525252;
    --color-border: #e5e5e5;
    --color-accent: #059669;
    --color-accent-muted: rgba(5, 150, 105, 0.1);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html {
    font-family: var(--font-sans);
    background: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Main */
  .main {
    flex: 1;
    padding: 2rem 0 2rem;
  }

  .article {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* Breadcrumbs */
  .breadcrumbs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 2rem;
  }

  .breadcrumbs a {
    color: var(--color-text-muted);
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumbs a:hover {
    color: var(--color-text);
  }

  .breadcrumbs .separator {
    opacity: 0.5;
  }

  .breadcrumbs .current {
    color: var(--color-text);
  }

  /* Cover Image */
  .cover-image {
    margin-bottom: 2rem;
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--color-border);
  }

  .cover-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Header */
  .header {
    margin-bottom: 3rem;
  }

  .header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
  }

  @media (max-width: 640px) {
    .header h1 {
      font-size: 1.875rem;
    }
  }

  /* Tags */
  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .tag {
    display: inline-flex;
    padding: 0.25rem 0.625rem;
    background: var(--color-accent-muted);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-accent);
  }

  .meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }

  .meta .separator {
    opacity: 0.5;
  }

  /* Content */
  .content {
    font-size: 1.0625rem;
    line-height: 1.75;
  }

  .content :global(h2) {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 3rem;
    margin-bottom: 1rem;
    letter-spacing: -0.01em;
  }

  .content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
  }

  .content :global(p) {
    margin-bottom: 1.25rem;
    color: var(--color-text-muted);
  }

  .content :global(ul),
  .content :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.5rem;
    color: var(--color-text-muted);
  }

  .content :global(li) {
    margin-bottom: 0.5rem;
  }

  .content :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .content :global(a:hover) {
    text-decoration: none;
  }

  .content :global(strong) {
    color: var(--color-text);
    font-weight: 600;
  }

  .content :global(code) {
    font-family: "Geist Mono", monospace;
    font-size: 0.875em;
    background: var(--color-bg-muted);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }

  .content :global(pre) {
    background: var(--color-bg-muted);
    border-radius: 0.5rem;
    padding: 1rem 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .content :global(pre code) {
    background: none;
    padding: 0;
  }

  .content :global(blockquote) {
    border-left: 3px solid var(--color-accent);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--color-text-muted);
    font-style: italic;
  }

  .content :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: 2.5rem 0;
  }

  .content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0 2rem;
    font-size: 0.9375rem;
  }

  .content :global(th),
  .content :global(td) {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .content :global(th) {
    background: var(--color-bg-muted);
    font-weight: 600;
    color: var(--color-text);
  }

  .content :global(td) {
    color: var(--color-text-muted);
  }

  .content :global(tr:hover td) {
    background: var(--color-bg-elevated);
  }

  .content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 1.5rem 0;
  }

  /* FAQ Section */
  .faq-section {
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .faq-section h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  .faq-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .faq-item {
    background: var(--color-bg-elevated);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .faq-item summary {
    padding: 1rem 1.25rem;
    font-weight: 500;
    cursor: pointer;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .faq-item summary::-webkit-details-marker {
    display: none;
  }

  .faq-item summary::after {
    content: "+";
    font-size: 1.25rem;
    color: var(--color-text-muted);
    transition: transform 0.2s;
  }

  .faq-item[open] summary::after {
    transform: rotate(45deg);
  }

  .faq-item p {
    padding: 0 1.25rem 1rem;
    color: var(--color-text-muted);
  }
</style>
