---
import { getDownloadUrl } from "../lib/github-releases"

interface DownloadRow {
  platform: string
  architecture: string
  format: string
  githubPlatform:
    | "macos-arm64"
    | "macos-x64"
    | "debian-x64"
    | "linux-x64"
    | "windows-x64"
}

const downloadRows: DownloadRow[] = [
  {
    platform: "macOS",
    architecture: "apple silicon",
    format: "dmg",
    githubPlatform: "macos-arm64",
  },
  {
    platform: "macOS",
    architecture: "intel",
    format: "dmg",
    githubPlatform: "macos-x64",
  },
  {
    platform: "Windows",
    architecture: "x86-64",
    format: "exe",
    githubPlatform: "windows-x64",
  },
  {
    platform: "debian",
    architecture: "x86-64",
    format: "deb",
    githubPlatform: "debian-x64",
  },
  {
    platform: "linux",
    architecture: "x86-64",
    format: "appimage",
    githubPlatform: "linux-x64",
  },
]

const downloads = await Promise.all(
  downloadRows.map(async (row) => ({
    ...row,
    ...(await getDownloadUrl(row.githubPlatform)),
  }))
)
---

<div class="not-content">
  <details class="platform-downloads">
    <summary class="trigger">
      <span>other platforms</span>
      <svg
        class="chevron"
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </summary>

    <div class="content">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>platform</th>
              <th>architecture</th>
              <th>format</th>
              <th>download</th>
            </tr>
          </thead>
          <tbody>
            {
              downloads.map((row) => (
                <tr>
                  <td>{row.platform}</td>
                  <td class="monospace">{row.architecture}</td>
                  <td class="monospace">{row.format}</td>
                  <td class="download-cell">
                    {row.downloadUrl ? (
                      <a
                        href={row.downloadUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="download-link"
                      >
                        download
                      </a>
                    ) : (
                      <span class="error">
                        {row.errorMessage || "unavailable"}
                      </span>
                    )}
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </details>
</div>

<a
  href="https://github.com/spacecake-labs/spacecake/releases"
  target="_blank"
  rel="noopener noreferrer"
  class="mobile-platform-link"
>
  other platforms
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
    <polyline points="15 3 21 3 21 9"></polyline>
    <line x1="10" y1="14" x2="21" y2="3"></line>
  </svg>
</a>

<style>
  .platform-downloads {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .mobile-platform-link {
    display: none;
    align-items: center;
    gap: 0.5rem;
    color: var(--sl-color-gray-3);
    font-size: var(--sl-text-sm);
    font-weight: 500;
    text-decoration: none;
    transition: color 0.2s;
  }

  .mobile-platform-link:hover {
    color: var(--sl-color-white);
  }

  @media (max-width: 50rem) {
    .platform-downloads {
      display: none;
    }

    .mobile-platform-link {
      display: flex;
      justify-content: center;
    }
  }

  .trigger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0;
    background: none;
    border: none;
    color: var(--sl-color-gray-3);
    cursor: pointer;
    font-size: var(--sl-text-sm);
    font-weight: 500;
    transition: color 0.2s;
    list-style: none;
  }

  .trigger:hover {
    color: var(--sl-color-white);
  }

  .trigger::-webkit-details-marker {
    display: none;
  }

  .chevron {
    transition: transform 0.2s;
  }

  .platform-downloads[open] .chevron {
    transform: rotate(180deg);
  }

  .content {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  .table-wrapper {
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    overflow: hidden;
    max-width: fit-content;
  }

  table {
    width: auto;
    border-collapse: collapse;
  }

  thead {
    background-color: color-mix(
      in srgb,
      var(--sl-color-gray-5) 50%,
      transparent
    );
    border-bottom: 1px solid var(--sl-color-gray-5);
  }

  th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-size: var(--sl-text-sm);
    font-weight: 500;
    color: var(--sl-color-white);
  }

  tbody tr {
    border-bottom: 1px solid var(--sl-color-gray-5);
    transition: background-color 0.2s;
  }

  tbody tr:last-child {
    border-bottom: none;
  }

  tbody tr:hover {
    background-color: color-mix(
      in srgb,
      var(--sl-color-gray-5) 30%,
      transparent
    );
  }

  td {
    padding: 0.75rem 1rem;
    font-size: var(--sl-text-sm);
    color: var(--sl-color-gray-3);
  }

  td.monospace {
    font-family: "Monaco", "Courier New", monospace;
  }

  .download-cell {
    padding: 0.75rem 1rem;
  }

  .download-link {
    color: var(--sl-color-accent);
    text-decoration: underline;
    transition: opacity 0.2s;
  }

  .download-link:hover {
    opacity: 0.8;
  }

  .error {
    color: var(--sl-color-gray-3);
    font-size: 0.875rem;
  }

  @media (prefers-reduced-motion: reduce) {
    .chevron {
      transition: none;
    }

    tbody tr {
      transition: none;
    }
  }
</style>
