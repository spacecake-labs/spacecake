---
// src/components/GitHubDownloadButton.astro
import { LinkButton } from "@astrojs/starlight/components";

interface Props {
  platform: "macos-arm64" | "macos-x64" | "windows-x64" | "linux-x64";
}

const { platform } = Astro.props;

const platformMap = {
  "macos-arm64": {
    pattern: "arm64.dmg",
    text: "download (apple silicon)",
  },
  "macos-x64": { pattern: "x64.dmg", text: "download (mac intel)" },
  "windows-x64": { pattern: "x64.msi", text: "download for windows (x64)" },
  "linux-x64": { pattern: "amd64.deb", text: "download for linux (x64)" },
};

const { pattern, text } = platformMap[platform];

let downloadUrl: string | undefined;
let errorMessage: string | undefined;

try {
  const response = await fetch(
    `https://api.github.com/repos/spacecake-labs/spacecake-releases/releases/latest`,
    {
      headers: {
        Accept: "application/vnd.github.v3+json",
      },
    }
  );

  if (!response.ok) {
    throw new Error(
      `GitHub API error: ${response.status} ${response.statusText}`
    );
  }

  const data = await response.json();
  const asset = data.assets?.find((a: any) => a.name.includes(pattern));

  if (asset) {
    downloadUrl = asset.browser_download_url;
  } else {
    errorMessage = `No matching asset found for "${platform}".`;
  }
} catch (error: any) {
  console.error(`Error fetching latest GitHub release for ${platform}:`, error);
  errorMessage = `Failed to fetch download URL: ${error.message}`;
}
---

{
  downloadUrl ? (
    <LinkButton
      variant="primary"
      rel="noopener noreferrer"
      href={downloadUrl}
      target="_blank"
    >
      {text}
    </LinkButton>
  ) : (
    <p class="starlight-badge badge brand">
      {errorMessage || "Download link not available."}
    </p>
  )
}
