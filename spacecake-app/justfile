start:
    pnpm run start

start-container:
    pnpm run start-container

make:
    pnpm run make

format:
    pnpm run format

lint:
    pnpm run lint

tc:
    pnpm run typecheck

check:
    just format && just lint && just tc

unit filter="":
    pnpm run unit-test {{filter}}

@_maybe_package:
    #!/usr/bin/env bash
    if [ ! -d "out/" ] || [ -n "$(find src -newer out/ -type f 2>/dev/null | head -1)" ]; then
        pnpm run package
    else
        echo "âœ“ package cache valid, skipping build"
    fi

e2e filter="":
    just _maybe_package && pnpm run e2e-test --grep="{{filter}}"

e2e-show filter="":
    just _maybe_package && pnpm run e2e-show --grep="{{filter}}"

e2e-repeat filter="" times="5":
    just _maybe_package && pnpm run e2e-test --grep="{{filter}}" --repeat-each={{times}}

test:
    just unit && just e2e

coverage:
    just _maybe_package && pnpm run coverage

codegen:
    just _maybe_package && npx tsx scripts/playwright-codegen.ts

drizzle:
    pnpm run drizzle

upgrade-lexical:
    pnpm update --latest lexical "@lexical/*"

print-py-nodes file:
    npx tsx scripts/print-py-nodes.ts {{file}}

print-py-nodes-tree file:
    npx tsx scripts/print-py-nodes-tree.ts {{file}}

gif input:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{input}}"
    output="${input%.mov}.gif"
    echo "Converting $input to $output"
    ffmpeg -i "$input" -vf "fps=15,scale=320:-1:flags=lanczos" -y "$output"